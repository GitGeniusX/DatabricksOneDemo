<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowit Performance Hub</title>
    <link rel="icon" type="image/png" href="assets/icons/knowit-favicon.png">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- Navigation will be inserted here -->
<div id="nav-placeholder"></div>

<div class="container" id="home">
  <div class="header">
    <div class="brand">
      <img src="assets/icons/Logotype-Knowit-Digital-Black.svg" alt="Knowit" class="logo" />
      <strong>Performance Hub</strong>
    </div>
    <div class="user">J</div>
  </div>
  <div class="hero">
    <h1>Hi, KYD!</h1>
    <p>What would you like to know?</p>
    <div class="search">
      <div class="box" id="search-box">
        <!-- Chat Messages Area (hidden initially) -->
        <div class="chat-messages-area" id="chat-messages-area" style="display: none;">
          <div class="chat-messages" id="home-chat-messages">
            <!-- AI responses appear here -->
          </div>
        </div>
        
        <!-- Input Controls (always visible at bottom of box) -->
        <div class="input-controls">
          <button class="btn-toggle" id="mode-search">Search</button>
          <button class="btn-toggle active" id="mode-ask">Ask AI</button>
          <input id="searchInput" placeholder="Ask me anything about your data..." />
          <button class="go" id="goButton" title="Go">✈️</button>
        </div>
      </div>
    </div>
  </div>
  <div class="cards">
    <div class="card" data-page="finance">
      <div class="label">Domain</div><h3>Financial Performance</h3>
      <canvas class="mini" id="mini-finance" height="72"></canvas>
    </div>
    <div class="card" data-page="delivery">
      <div class="label">Domain</div><h3>Delivery & Operations</h3>
      <canvas class="mini" id="mini-delivery" height="72"></canvas>
    </div>
    <div class="card" data-page="people">
      <div class="label">Domain</div><h3>People & Talent</h3>
      <canvas class="mini" id="mini-people" height="72"></canvas>
    </div>
    <div class="card" data-page="clients">
      <div class="label">Domain</div><h3>Client Success</h3>
      <canvas class="mini" id="mini-clients" height="72"></canvas>
    </div>
  </div>
  <div class="tabs">
    <div class="tab-chip active">For you</div>
    <div class="tab-chip">Genie Spaces</div>
    <div class="tab-chip">Domains</div>
    <div class="tab-chip">Dashboards</div>
    <div class="tab-chip">Apps</div>
  </div>
</div>

<!-- Domain pages -->
<div class="container page" id="page-finance">
  <button class="btn back" data-back>← Back</button>
  <h2>Financial Performance</h2>
  <div class="filterbar">
    <select class="select" id="fin-bu">
      <option value="all" selected>All BUs</option>
      <option value="Solutions">Solutions</option>
      <option value="Experience">Experience</option>
      <option value="Insight">Insight</option>
      <option value="Connectivity">Connectivity</option>
    </select>
    <select class="select" id="fin-country">
      <option value="Nordics">Nordics</option>
      <option value="SE">Sweden</option>
      <option value="NO">Norway</option>
      <option value="FI">Finland</option>
      <option value="DK">Denmark</option>
    </select>
    <div class="horizon" id="fin-horizon">
      Horizon:
      <button data-h="3" class="active">3m</button>
      <button data-h="6">6m</button>
      <button data-h="12">12m</button>
    </div>
    <button class="btn" id="fin-explain">Explain variance</button>
  </div>
  <div class="kpis" id="fin-kpis"></div>
  <div class="grid-2x2">
    <div class="chart"><h4>Revenue Forecast vs Actuals</h4><canvas id="fin-rev" height="180"></canvas><div class="legend"><span><span class="swatch" style="background:var(--primary);"></span>Actual &amp; Forecast</span><span><span class="swatch" style="background:var(--accent);opacity:0.4;"></span>Confidence band</span></div></div>
    <div class="chart"><h4>Profitability by Service Line</h4><canvas id="fin-margin" height="180"></canvas></div>
    <div class="chart"><h4>Rolling 12-Month Growth</h4><canvas id="fin-grow" height="180"></canvas></div>
    <div class="chart"><h4>Billing Rate Trend</h4><canvas id="fin-rate" height="180"></canvas></div>
  </div>
</div>

<div class="container page" id="page-delivery">
  <button class="btn back" data-back>← Back</button>
  <h2>Delivery &amp; Operations</h2>
  <div class="filterbar">
    <select class="select" id="del-bu">
      <option value="all" selected>All Teams</option>
      <option value="Solutions">Solutions</option>
      <option value="Experience">Experience</option>
      <option value="Insight">Insight</option>
      <option value="Connectivity">Connectivity</option>
    </select>
    <div class="horizon" id="del-horizon">
      Horizon:
      <button data-h="6" class="active">6w</button>
      <button data-h="12">12w</button>
    </div>
  </div>
  <div class="kpis" id="del-kpis"></div>
  <div class="grid-2x2">
    <div class="chart"><h4>Utilization Heatmap (Forecast)</h4><canvas id="del-heat" height="200"></canvas></div>
    <div class="chart"><h4>Bench Forecast</h4><canvas id="del-bench" height="180"></canvas></div>
    <div class="chart"><h4>Resource Allocation</h4><canvas id="del-alloc" height="180"></canvas></div>
    <div class="chart"><h4>On-Time Delivery %</h4><canvas id="del-otd" height="180"></canvas></div>
  </div>
</div>

<div class="container page" id="page-people">
  <button class="btn back" data-back>← Back</button>
  <h2>People &amp; Talent</h2>
  <div class="filterbar">
    <select class="select" id="peo-bu">
      <option value="all" selected>All BUs</option>
      <option value="Solutions">Solutions</option>
      <option value="Experience">Experience</option>
      <option value="Insight">Insight</option>
      <option value="Connectivity">Connectivity</option>
    </select>
    <div class="horizon" id="peo-horizon">
      Horizon:
      <button data-h="6" class="active">6m</button>
      <button data-h="12">12m</button>
    </div>
  </div>
  <div class="kpis" id="peo-kpis"></div>
  <div class="grid-2x2">
    <div class="chart"><h4>Headcount Forecast vs Demand</h4><canvas id="peo-hc" height="180"></canvas><div class="legend"><span><span class="swatch" style="background:var(--primary);"></span>Headcount</span><span><span class="swatch" style="background:var(--primary-alt);"></span>Demand</span></div></div>
    <div class="chart"><h4>Attrition Forecast</h4><canvas id="peo-attr" height="180"></canvas></div>
    <div class="chart"><h4>Skills Coverage (Needed vs Available)</h4><canvas id="peo-skill" height="180"></canvas></div>
    <div class="chart"><h4>Internal Mobility</h4><canvas id="peo-mob" height="180"></canvas></div>
  </div>
</div>

<div class="container page" id="page-clients">
  <button class="btn back" data-back>← Back</button>
  <h2>Client Success</h2>
  <div class="filterbar">
    <select class="select" id="cli-tier">
      <option value="all" selected>All Tiers</option>
      <option value="A">Tier A</option>
      <option value="B">Tier B</option>
      <option value="C">Tier C</option>
    </select>
    <div class="horizon" id="cli-horizon">
      Horizon:
      <button data-h="6" class="active">6m</button>
      <button data-h="12">12m</button>
    </div>
  </div>
  <div class="kpis" id="cli-kpis"></div>
  <div class="grid-2x2">
    <div class="chart"><h4>Retention &amp; Churn Forecast</h4><canvas id="cli-ret" height="180"></canvas><div class="legend"><span><span class="swatch" style="background:var(--primary);"></span>Retention</span><span><span class="swatch" style="background:var(--primary-alt);"></span>Churn</span></div></div>
    <div class="chart"><h4>Revenue by Client Cohort</h4><canvas id="cli-cohort" height="180"></canvas></div>
    <div class="chart"><h4>Client Mix Treemap</h4><canvas id="cli-mix" height="180"></canvas></div>
    <div class="chart"><h4>NPS vs Revenue Growth</h4><canvas id="cli-nps" height="180"></canvas></div>
  </div>
</div>

<div class="sidepanel" id="panel">
  <h3>Variance explanation</h3>
  <div id="panel-content"></div>
  <button class="btn" id="panel-close">Close</button>
</div>

<div class="footer-note">Sprint 0 canvas mockup • No real data • Style &amp; logos configurable in Sprint 2 via CSS variables and .logo slot.</div>

<!-- Scripts -->
<script src="js/data.js"></script>
<script src="js/charts.js"></script>
<script src="js/navigation.js"></script>
<script src="js/interactions.js"></script>
<script src="js/app.js"></script>
  
<!-- Chat Enhancement Script -->
<script>
  // Override old search to enable chat functionality
  window.addEventListener('DOMContentLoaded', function() {
    // Initialize home chat interface
    initializeHomeChatInterface();
  });
    
  // Home Chat Interface Functions
  function initializeHomeChatInterface() {
    // No separate chat input needed - using main search box only
    console.log('Home chat interface initialized');
  }
  
  function startHomeChatWithQuery(query) {
    const searchBox = document.getElementById('search-box');
    const chatMessagesArea = document.getElementById('chat-messages-area');
    const searchInput = document.getElementById('searchInput');
    
    // Show chat area and expand box
    chatMessagesArea.style.display = 'block';
    searchBox.classList.add('chat-active');
    
    // Clear search input
    searchInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Simulate AI response
    setTimeout(async () => {
      try {
        const response = await mockData.askQuestion(query);
        hideTypingIndicator();
        addChatMessage(response, 'assistant');
      } catch (error) {
        hideTypingIndicator();
        addChatMessage({
          summary: ['Sorry, I encountered an error processing your question. Please try again.'],
          linkedVisuals: []
        }, 'assistant');
      }
    }, 1500);
  }
  


  function addChatMessage(content, sender) {
    const chatMessages = document.getElementById('home-chat-messages');
    if (!chatMessages) return;
      
    // Only show AI responses
    if (sender === 'user') {
      return;
    }
    
    // Clear any existing messages to prevent duplicates
    chatMessages.innerHTML = '';
      
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message assistant';
      
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
      
    // Clean response without avatars or timestamps
    const summaryHtml = content.summary.map(point => 
      `<div class="ask-response-line">${escapeHtml(point)}</div>`
    ).join('');
        
    const linksHtml = content.linkedVisuals.length > 0 ? `
      <div class="message-links">
        ${content.linkedVisuals.map(visual => 
          `<button class="chart-link" onclick="openChatChart('${escapeHtml(visual)}')">
            <i class="fas fa-chart-bar"></i> ${escapeHtml(visual)}
          </button>`
        ).join('')}
      </div>
    ` : '';
        
    messageContent.innerHTML = `
      <div class="message-text">
        ${summaryHtml}
        ${linksHtml}
      </div>
    `;
      
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom if needed
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
    
  function showTypingIndicator() {
    const chatMessages = document.getElementById('home-chat-messages');
    if (!chatMessages) return;
      
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typing-indicator';
      
    typingDiv.innerHTML = `
      <span style="color: #6b7280; font-size: 14px; font-style: italic;">AI is thinking...</span>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
      
    chatMessages.appendChild(typingDiv);
  }
    
  function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
      typingIndicator.remove();
    }
  }
    
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Chart Modal Setup
  document.addEventListener('DOMContentLoaded', function() {
    // Add chart modal to body
    const chartModal = document.createElement('div');
    chartModal.id = 'chart-modal';
    chartModal.className = 'chart-modal';
    chartModal.innerHTML = `
      <div class="chart-modal-content">
        <div class="chart-modal-header">
          <div class="chart-modal-title">
            <i class="fas fa-chart-bar"></i>
            <span id="chart-modal-title-text">Chart Title</span>
          </div>
          <button class="chart-modal-close" onclick="closeChatChartModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chart-modal-body" id="chart-modal-body">
          <div class="chart-placeholder">
            <div class="chart-placeholder-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <h4>Interactive Chart View</h4>
            <p>This would show the full interactive chart with drill-down capabilities, filters, and export options.</p>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(chartModal);
  });
    
  // Override old runQuery to start home chat
  const originalRunQuery = window.runQuery;
  window.runQuery = function() {
    const q = document.getElementById('searchInput').value.trim();
    if (!q) return;
      
    // Start chat on home page
    startHomeChatWithQuery(q);
  };
  
  // Remove old event listeners and add new ones that use our override
  setTimeout(() => {
    const goButton = document.getElementById('goButton');
    const searchInput = document.getElementById('searchInput');
    
    if (goButton) {
      // Clone button to remove all event listeners
      const newGoButton = goButton.cloneNode(true);
      goButton.parentNode.replaceChild(newGoButton, goButton);
      // Add our new event listener
      newGoButton.addEventListener('click', window.runQuery);
    }
    
    if (searchInput) {
      // Clone input to remove all event listeners
      const newSearchInput = searchInput.cloneNode(true);
      searchInput.parentNode.replaceChild(newSearchInput, searchInput);
      // Add our new event listener
      newSearchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') window.runQuery();
      });
    }
  }, 100);
    
  // No need for enhanced showPage anymore - just use original
  
  // Chart modal functions for chat links
  window.openChatChart = function(chartName) {
    const modal = document.getElementById('chart-modal');
    const titleElement = document.getElementById('chart-modal-title-text');
    if (modal && titleElement) {
      titleElement.textContent = chartName;
      modal.classList.add('active');
    }
  };
  
  window.closeChatChartModal = function() {
    const modal = document.getElementById('chart-modal');
    if (modal) {
      modal.classList.remove('active');
    }
  };
</script>
</body>
</html>